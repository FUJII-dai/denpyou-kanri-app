# 伝票管理アプリ (denpyou-kanri-app) 再構築計画

## 現在の問題点

1. **アーキテクチャの一貫性の欠如**
   - コンポーネント間の責任分担が不明確
   - 状態管理とデータフローが複雑で追跡困難
   - エラー処理が不十分

2. **モバイル対応の不備**
   - 特にレジ金確認ページの入力フィールドが機能しない
   - 数値入力のハンドリングが不適切

3. **初期化処理の脆弱性**
   - データベース接続エラー時の代替メカニズムがない
   - 非同期処理の管理が不十分

4. **拡張性の制限**
   - 新機能追加時の影響範囲が予測困難
   - コードの再利用性が低い

## 再構築の目標

1. **クリーンアーキテクチャの導入**
   - 関心の分離を徹底
   - データ、ビジネスロジック、UIの明確な分離

2. **堅牢なデータフロー**
   - React QueryとZustandの統合
   - 一貫したデータ取得・更新パターン

3. **モバイルファースト設計**
   - すべての入力コンポーネントの最適化
   - レスポンシブUIの徹底

4. **エラー処理の強化**
   - 包括的なエラーバウンダリ
   - ユーザーフレンドリーなエラーメッセージ

5. **拡張性の向上**
   - 再利用可能なコンポーネント
   - 明確なAPIとインターフェース

## 実装計画

### 1. フォルダ構造の再編成

```
src/
├── api/            # APIクライアント
├── components/     # UIコンポーネント
│   ├── forms/      # フォームコンポーネント
│   ├── ui/         # 基本UIコンポーネント
│   └── wrappers/   # ラッパーコンポーネント
├── hooks/          # カスタムフック
├── layouts/        # レイアウトコンポーネント
├── routes/         # ルーティング
├── store/          # 状態管理
└── types/          # 型定義
    └── schema/     # スキーマ定義
```

### 2. コアコンポーネントの再実装

1. **App.tsx**
   - React Queryの統合
   - エラーバウンダリの実装
   - オフライン/オンライン状態の管理

2. **ルーティングシステム**
   - React Routerの導入
   - コンポーネントの遅延ロード
   - ナビゲーション状態の管理

3. **UIコンポーネント**
   - NumberInput: モバイル最適化された数値入力
   - LoadingSpinner: 読み込み状態の表示
   - ErrorBoundary: エラー処理
   - PageWrapper: 一貫したページレイアウト

### 3. データ管理の改善

1. **APIレイヤー**
   - Supabaseクライアントのラッピング
   - 一貫したエラーハンドリング
   - キャッシュ戦略

2. **状態管理**
   - ZustandストアとReact Queryの統合
   - 永続化と同期メカニズム
   - 型安全な状態管理

### 4. レジ金確認ページの再実装

1. **RegisterCash.tsx**
   - 堅牢な初期化処理
   - エラー処理の強化
   - モバイル対応の改善

2. **RegisterCashForm.tsx**
   - 最適化された入力フィールド
   - 検証ロジックの改善
   - ユーザーフレンドリーなUI

3. **registerCashStore.ts**
   - 型安全なスキーマ
   - 堅牢なデータ同期
   - エラー状態の管理

## 実装の優先順位

1. コアインフラストラクチャ（App.tsx、ルーティング）
2. 共通UIコンポーネント
3. データ管理レイヤー
4. レジ金確認ページの再実装
5. その他のページの移行

## 検証計画

1. すべてのページが正しく読み込まれ、初期化されることを確認
2. レジ金確認ページのすべての入力フィールドが正常に機能することを確認
3. オフライン/オンライン遷移時の状態処理を確認
4. データベース同期が確実に機能することを確認
5. アプリケーション全体の一貫性を確認

## 期待される成果

1. 安定したユーザー体験
2. 保守性と拡張性の向上
3. モバイルデバイスでの完全な機能性
4. 将来の機能追加の容易化
